name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.id }}
    steps:
      - uses: actions/checkout@v4

      - name: Create Release
        id: create-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: VINY ${{ github.ref_name }}
          body: |
            ## VINY ${{ github.ref_name }}

            ### Downloads

            | Platform | Download |
            |----------|----------|
            | macOS (Apple Silicon) | `VINY_*.dmg` |
            | Windows | `VINY_*-setup.exe` or `VINY_*.msi` |
            | Linux | `VINY_*.AppImage` or `VINY_*.deb` |

            ### Installation

            **macOS**: Download the `.dmg`, open it, and drag VINY to Applications.

            **Windows**: Download the `.exe` installer and run it.

            **Linux**: Download the `.AppImage`, make it executable (`chmod +x`), and run it.
          draft: true
          prerelease: false

  # Build for Windows and Linux
  build-tauri:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            args: ''
          - platform: windows-latest
            args: ''
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './apps/desktop/src-tauri -> target'

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: './apps/desktop'
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ matrix.args }}

  # macOS build with manual notarization and retries
  build-macos:
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './apps/desktop/src-tauri -> target'

      - name: Install frontend dependencies
        run: pnpm install

      - name: Import Apple certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain
          rm certificate.p12

      - name: Resolve signing identity
        id: signing-identity
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          set -euo pipefail
          if [ -n "${APPLE_SIGNING_IDENTITY:-}" ]; then
            echo "Using signing identity from secret"
            echo "identity=${APPLE_SIGNING_IDENTITY}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          IDENTITY=$(security find-identity -v -p codesigning | awk '/Developer ID Application/ {print $2; exit}')
          if [ -z "$IDENTITY" ]; then
            echo "No Developer ID Application identity found in the keychain"
            exit 1
          fi

          echo "Detected signing identity: $IDENTITY"
          echo "identity=$IDENTITY" >> "$GITHUB_OUTPUT"

      - name: Build Tauri app (with signing, without notarization)
        id: build-macos-artifact
        env:
          APPLE_SIGNING_IDENTITY: ${{ steps.signing-identity.outputs.identity }}
        run: |
          set -euo pipefail
          cd apps/desktop
          pnpm tauri build --target aarch64-apple-darwin

          DMG_PATH=$(find src-tauri/target/aarch64-apple-darwin/release/bundle/dmg -name "*.dmg" | head -1)
          if [ -z "$DMG_PATH" ]; then
            echo "DMG not found after build"
            exit 1
          fi

          DMG_PATH=$(realpath "$DMG_PATH")
          echo "Built DMG at $DMG_PATH"
          echo "dmg_path=$DMG_PATH" >> "$GITHUB_OUTPUT"

      - name: Notarize with retries
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          DMG_PATH: ${{ steps.build-macos-artifact.outputs.dmg_path }}
        run: |
          set -euo pipefail
          echo "Found DMG: $DMG_PATH"

          MAX_RETRIES=5
          RETRY_DELAY=60

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Notarization attempt $i of $MAX_RETRIES..."

            if xcrun notarytool submit "$DMG_PATH" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --wait \
              --timeout 30m; then
              echo "Notarization successful!"
              xcrun stapler staple "$DMG_PATH"
              echo "Stapling complete!"
              break
            else
              if [ $i -eq $MAX_RETRIES ]; then
                echo "Notarization failed after $MAX_RETRIES attempts"
                exit 1
              fi
              echo "Attempt $i failed, waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
            fi
          done

      - name: Upload to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DMG_PATH: ${{ steps.build-macos-artifact.outputs.dmg_path }}
        run: |
          gh release upload "${{ github.ref_name }}" "$DMG_PATH" --clobber

  publish-release:
    needs: [create-release, build-tauri, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.create-release.outputs.release_id }},
              draft: false
            })
